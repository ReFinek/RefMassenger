<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Простой общий чат</title>
    <style>
        body { font-family: Arial; max-width: 600px; margin: 0 auto; padding: 20px; }
        .chat-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #fafafa; }
        .message { margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 5px; }
        .message-time { font-size: 0.8em; color: #666; }
        textarea { width: 100%; height: 60px; padding: 10px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .notification { padding: 10px; margin: 10px 0; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="chat-container">
        <h2>Простой общий чат</h2>
        
        <div class="notification" id="notification"></div>
        
        <div class="messages" id="messages"></div>
        
        <textarea id="messageInput" placeholder="Введите сообщение..."></textarea>
        
        <div>
            <button onclick="sendMessage()">Отправить</button>
            <button onclick="loadMessages()" style="background: #28a745;">Обновить</button>
            <button onclick="setupGist()" style="background: #6c757d;">Настроить Gist</button>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <h4>Как настроить:</h4>
            <ol>
                <li>Создайте Gist на <a href="https://gist.github.com" target="_blank">gist.github.com</a></li>
                <li>Назовите файл <code>chat.json</code></li>
                <li>Содержимое: <code>{"messages":[]}</code></li>
                <li>Нажмите "Create public gist"</li>
                <li>Скопируйте ID из URL (например: <code>https://gist.github.com/username/<strong>abc123...</strong></code>)</li>
                <li>Вставьте ID ниже и сохраните</li>
            </ol>
            <input type="text" id="gistId" placeholder="ID вашего Gist" style="width: 300px; padding: 5px;">
            <input type="text" id="githubToken" placeholder="GitHub Token (опционально)" style="width: 300px; padding: 5px; margin-left: 10px;">
            <button onclick="saveGistConfig()" style="background: #17a2b8;">Сохранить настройки</button>
        </div>
    </div>

    <script>
        let messages = [];
        let gistId = '';
        let githubToken = '';

        // Загрузка конфигурации
        function loadConfig() {
            const savedGistId = localStorage.getItem('chatGistId');
            const savedToken = localStorage.getItem('chatGithubToken');
            
            if (savedGistId) {
                gistId = savedGistId;
                document.getElementById('gistId').value = gistId;
            }
            
            if (savedToken) {
                githubToken = savedToken;
                document.getElementById('githubToken').value = githubToken;
            }
            
            if (gistId) {
                loadMessages();
            }
        }

        function saveGistConfig() {
            gistId = document.getElementById('gistId').value.trim();
            githubToken = document.getElementById('githubToken').value.trim();
            
            localStorage.setItem('chatGistId', gistId);
            localStorage.setItem('chatGithubToken', githubToken);
            
            showNotification('Настройки сохранены!', 'success');
            loadMessages();
        }

        // Загрузка сообщений из Gist
        async function loadMessages() {
            if (!gistId) {
                showNotification('Сначала настройте Gist', 'error');
                return;
            }

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`);
                if (!response.ok) throw new Error('Gist не найден');
                
                const gistData = await response.json();
                const chatFile = gistData.files['chat.json'] || gistData.files[Object.keys(gistData.files)[0]];
                
                if (chatFile && chatFile.content) {
                    const data = JSON.parse(chatFile.content);
                    messages = data.messages || [];
                    displayMessages();
                    showNotification('Сообщения загружены', 'success');
                }
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                showNotification('Ошибка загрузки сообщений', 'error');
            }
        }

        // Сохранение сообщений в Gist
        async function saveMessages() {
            if (!gistId) {
                showNotification('Сначала настройте Gist', 'error');
                return;
            }

            try {
                const content = {
                    messages: messages.slice(-100) // сохраняем последние 100 сообщений
                };

                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(githubToken && { 'Authorization': `token ${githubToken}` })
                    },
                    body: JSON.stringify({
                        files: {
                            'chat.json': {
                                content: JSON.stringify(content, null, 2)
                            }
                        }
                    })
                });

                if (!response.ok) throw new Error('Ошибка сохранения');
                
                showNotification('Сообщение отправлено!', 'success');
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                showNotification('Ошибка отправки сообщения', 'error');
            }
        }

        function displayMessages() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<div style="text-align: center; color: #666;">Чат пуст</div>';
                return;
            }
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-time">${msg.time}</div>
                    <div>${escapeHtml(msg.text)}</div>
                `;
                messagesContainer.appendChild(messageDiv);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text === '') {
                showNotification('Введите сообщение!', 'error');
                return;
            }

            const newMessage = {
                text: text,
                time: new Date().toLocaleTimeString(),
                timestamp: Date.now()
            };

            messages.push(newMessage);
            input.value = '';
            displayMessages();
            
            await saveMessages();
        }

        function setupGist() {
            window.open('https://gist.github.com', '_blank');
            showNotification('Создайте Gist с файлом chat.json и содержимым: {"messages":[]}', 'success');
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Автообновление каждые 5 секунд
        setInterval(loadMessages, 5000);

        // Загрузка при старте
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
